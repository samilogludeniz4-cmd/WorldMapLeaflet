<!doctype html>
<html lang="tr">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Dünya Haritası</title>
    <link rel="stylesheet" href="/Lib/Leaflet/dist/leaflet.css"/>
    <style>
        html,body{height:100%;margin:0} #map{height:100%}
        /* Google Maps benzeri arama kutusu */
        #searchPanel{
            position:absolute;top:15px;left:15px;z-index:99999;
            width:360px;background:#fff;border-radius:10px;
            box-shadow:0 2px 10px rgba(0,0,0,.2);border:1px solid #e6e6e6;
            display:flex;align-items:center;gap:8px;padding:8px 10px;
        }
        #q{
            flex:1;border:none;outline:none;font-size:15px;
        }
        #go{
            border:1px solid #ddd;background:#fff;border-radius:8px;
            padding:6px 10px;cursor:pointer;
        }
    </style>
</head>
<body>
<div id="searchPanel">
    <!-- datalist bağladık -->
    <input id="q" list="suggs" placeholder="İl, ilçe, mahalle, sokak ara…" autocomplete="off"/>
    <datalist id="suggs"></datalist>
    <button id="go">Ara</button>
</div>

<div id="map"></div>

<script src="/Lib/Leaflet/dist/leaflet.js"></script>
<script>
    // Harita
    const map = L.map('map',{worldCopyJump:true}).setView([39,35],6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
        {maxZoom:18, attribution:'&copy; OpenStreetMap'}).addTo(map);
    map.zoomControl.setPosition('topright');

    // Tek marker
    const markers=L.layerGroup().addTo(map);
    function setMarker(lat,lon,name){
        markers.clearLayers();
        const p=[lat,lon];
        L.marker(p).addTo(markers).bindPopup(name).openPopup();
        map.flyTo(p, 15, {duration:.6});
    }

    const q = document.getElementById('q');
    const list = document.getElementById('suggs');
    let timer=null, lastResults=[];

    // Yazdıkça öneri getir (datalist doldur)
    q.addEventListener('input', ()=>{
        const val=q.value.trim();
        if(!val){ list.innerHTML=''; return; }
        clearTimeout(timer);
        timer=setTimeout(()=>{
            fetch('/api/geocode?q='+encodeURIComponent(val))
                .then(r=>r.ok?r.json():[])
                .then(d=>{
                    lastResults = d || [];
                    // datalist seçenekleri
                    list.innerHTML = lastResults.map(r =>
                        `<option value="${r.display_name.replaceAll('"','&quot;')}">`).join('');
                })
                .catch(()=>{ list.innerHTML=''; });
        }, 200);
    });

    // Ara butonu veya Enter → ilk eşleşmeye git
    function go(){
        const val=q.value.trim();
        if(!val) return;
        // Eğer yazılan değer, listeden birinin aynısıysa onu bul
        const exact = lastResults.find(r => r.display_name === val) || lastResults[0];
        if(!exact) return;
        setMarker(parseFloat(exact.lat), parseFloat(exact.lon), exact.display_name);
    }
    document.getElementById('go').addEventListener('click', go);
    q.addEventListener('keydown', e => { if(e.key==='Enter') go(); });
</script>
</body>
</html>
